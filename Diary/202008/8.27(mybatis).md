## Mybatis

### 1. 动态SQL

* 动态sql就是指根据不同的条件，生成不同的sql语句
* 利用动态 SQL，可以彻底摆脱这种痛苦。
* 所谓的动态SQL，本质还是SQL语句。只是我们可以在SQL层面，去执行一个逻辑代码。
* 标签：
  * if
  * choose (when, otherwise)
  * trim (where, set)
  * foreach



#### 搭建环境

```sql
CREATE TABLE `blog`(
    `id` VARCHAR(50) NOT NULL COMMENT '博客id',
    `title` VARCHAR(100) NOT NULL COMMENT '博客标题',
    `author` VARCHAR(30) NOT NULL COMMENT '博客作者',
    `create_time` DATETIME NOT NULL COMMENT '创建时间',
    `views` INT(30) NOT NULL COMMENT '浏览量'
) ENGINE=INNODB DEFAULT CHARSET=utf8;
```



#### 1.1 if

* 需求：若传入一个title，则按照title查询；若传入一个author，则按照author查询；若没有传入，则查询全部。

**接口**

```java
	//查询博客
    List<Blog> queryBlogIF(Map<String,Object> map);
```

**Mapper.xml**

```xml
    <select id="queryBlogIF" parameterType="map" resultType="blog">
        select `id`,`title`,`author`,`create_time`,`views` from blog
        <where>
            <if test="title != null">
                `title` = #{title}
            </if>
            <if test="author != null">
                and `author` = #{author}
            </if>
        </where>
    </select>
```

**测试**

```java
    @Test
    public void queryBlogIF(){
        SqlSession sqlSession = MybatisUtils.getSqlSession();
        BlogMapper mapper = sqlSession.getMapper(BlogMapper.class);
        Map<String,Object> map = new HashMap<>();

//        map.put("title","山海皆可平");
        map.put("author","lyb");

        List<Blog> list = mapper.queryBlogIF(map);
        list.forEach(System.out::println);
    }
```



#### 1.2 choose (when, otherwise)

**接口**

```java
	//查询博客
    List<Blog> queryBlogChoose(Map<String,Object> map);
```

**Mapper.xml**

```xml
    <select id="queryBlogChoose" parameterType="map" resultType="blog">
        select `id`,`title`,`author`,`create_time`,`views` from blog
        <where>
            <choose>
                <when test="title != null">
                    `title` = #{title}
                </when>
                <when test="author != null">
                    `author` = #{author}
                </when>
                <otherwise>
                    `views` = #{views}
                </otherwise>
            </choose>
        </where>
    </select>
```

**测试**

```java
    @Test
    public void queryBlogChoose(){
        SqlSession sqlSession = MybatisUtils.getSqlSession();
        BlogMapper mapper = sqlSession.getMapper(BlogMapper.class);
        Map<String,Object> map = new HashMap<>();

//        map.put("title","山海皆可平");
//        map.put("author","lyb");
        map.put("views",5000);
        List<Blog> list = mapper.queryBlogChoose(map);
        list.forEach(System.out::println);
    }
```



#### 1.3 trim、set

**接口**

```java
    //更新博客
    int updateBlog(Map<String,Object> map);
```

**Mapper.xml**

```xml
    <update id="updateBlog" parameterType="map">
        update blog
        <set>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="author != null">
                author = #{author}
            </if>
        </set>
        where id = #{id}
    </update>
```

**测试**

```java
    @Test
    public void updateBlog(){
        SqlSession sqlSession = MybatisUtils.getSqlSession();
        BlogMapper mapper = sqlSession.getMapper(BlogMapper.class);
        Map<String,Object> map = new HashMap<>();

        map.put("title","山海皆可平3");
//        map.put("author","lyb");
        map.put("id","4a448da4dbc443e78d7d80deac6ef6a7");
        System.out.println(mapper.updateBlog(map));
        sqlSession.commit();
    }
```



#### 1.4 SQL片段

* 可以吧公共部分的sql抽取出来，在需要的部分用include导入

```xml
    <sql id="if-title-author">
        <if test="title != null">
            `title` = #{title}
        </if>
        <if test="author != null">
            and `author` = #{author}
        </if>
    </sql>
    <select id="queryBlogIF" parameterType="map" resultType="blog">
        select `id`,`title`,`author`,`create_time`,`views` from blog
        <where>
            <include refid="if-title-author"/>
        </where>
    </select>
```



#### 1.5 Foreach

* 需求：查询第1,2,3号记录的博客

**接口**

```java
    //查询第1,2,3号记录的博客
    List<Blog> queryBlogForeach(Map<String,Object> map);

    List<Blog> queryBlogForeach2(Map<String,Object> map);
```

Mapper.xml

```xml
    <!--方式一-->
    <select id="queryBlogForeach" parameterType="map" resultType="blog">
          select `id`,`title`,`author`,`create_time`,`views` from blog
          <where>
              <foreach collection="ids" item="id" open=" ( " close=" ) " separator="or">
                  id = #{id}
              </foreach>
          </where>
    </select>

    <!--方式二-->
    <select id="queryBlogForeach2" parameterType="map" resultType="blog">
        select `id`,`title`,`author`,`create_time`,`views` from blog where id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

```

**测试**

```java
    @Test
    public void queryBlogForeach(){
        SqlSession sqlSession = MybatisUtils.getSqlSession();
        BlogMapper mapper = sqlSession.getMapper(BlogMapper.class);
        Map<String,Object> map = new HashMap<>();
        List<Integer> ids = new ArrayList<>();
        ids.add(1);
        ids.add(2);
        ids.add(3);
        map.put("ids",ids);
//        List<Blog> list = mapper.queryBlogForeach(map);
        List<Blog> list = mapper.queryBlogForeach2(map);
        list.forEach(System.out::println);
        
    }
```

